# hw definition file for processing by chibios_pins.py
# for iFlight Beast H7 hardware.
# thanks to betaflight for pin information

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# board ID for firmware load
APJ_BOARD_ID 50

# crystal frequency, setup to use external oscillator
OSCILLATOR_HZ 8000000

define CONFIG_HAL_BOARD_SUBTYPE HAL_BOARD_SUBTYPE_CHIBIOS_FMUV5
define HAL_CHIBIOS_ARCH_FMUV5 1

# flash size
FLASH_SIZE_KB 2048

env OPTIMIZE -O2

# bootloader takes first sector
FLASH_RESERVE_START_KB 128

# ChibiOS system timer
STM32_ST_USE_TIMER 12
define CH_CFG_ST_RESOLUTION 16

# Debug
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART1 UART7

# USB
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# USART1 (telem2)
PA10 USART1_RX USART1
PA9  USART1_TX USART1

# USART2 (telem2)
PD6 USART2_RX USART2
PD5 USART2_TX USART2

# USART3 (telem2)
# PD9 USART3_RX USART3
PB3 UART7_RX UART7
define HAL_SERIAL2_PROTOCOL SerialProtocol_RCIN


# also USART7_RX for serial RC
# PB3 TIM2_CH2 TIM2 RCININT FLOAT LOW   
# PE8 UART7_TX UART7 NODMA
# PB3 UART7_RX UART7 NODMA ALT(1)

# no ADC pins
define HAL_USE_ADC FALSE

# Motord
PA8  TIM1_CH1  TIM1  PWM(1)  GPIO(50)
PE11 TIM1_CH2  TIM1  PWM(2)  GPIO(51)
PE13 TIM1_CH3  TIM1  PWM(3)  GPIO(52)
PE14 TIM1_CH4  TIM1  PWM(4)  GPIO(53)

PD13 TIM4_CH2  TIM4  PWM(5)  GPIO(54) #for ws2812
PE5  TIM15_CH1 TIM15 PWM(6)  GPIO(55) #for ws2812
PC7  TIM3_CH2  TIM3  PWM(7)  GPIO(56) #for voltage pwm
# PE6  TIM15_CH2 TIM15 PWM(5)  GPIO(54)

define BOARD_PWM_COUNT_DEFAULT 6

# PA2  TIM2_CH3  TIM2  PWM(5)  GPIO(54)

# NeoPixel LED strip

# define HAL_PERIPH_ENABLE_RC_OUT
# define HAL_PERIPH_ENABLE_NOTIFY

# Beeper
PB4 TIM3_CH1 TIM3 GPIO(60) ALARM
define HAL_BUZZER_ON 0
define HAL_BUZZER_OFF 1

# microSD support
PC8 SDMMC1_D0 SDMMC1
PC9 SDMMC1_D1 SDMMC1
PC10 SDMMC1_D2 SDMMC1
PC11 SDMMC1_D3 SDMMC1
PC12 SDMMC1_CK SDMMC1
PD2 SDMMC1_CMD SDMMC1

define HAL_STORAGE_SIZE 16384
# use last 2 pages for flash storage
# H743 has 16 pages of 128k each
define STORAGE_FLASH_PAGE 14

# only one I2C bus
I2C_ORDER I2C1

# I2C1 for baro
PB6 I2C1_SCL I2C1 
PB9 I2C1_SDA I2C1 

# MS5611  
COMPASS IST8310 I2C:0:0x0C false ROTATION_NONE
define HAL_PROBE_EXTERNAL_I2C_COMPASSES

# one baro
BARO MS56XX I2C:0:0x77

# SPI1  
PC3 ADXL_CS CS
PC5 ADXRSa_CS CS
PC4 ADXRSb_CS CS
PA5 SPI1_SCK SPI1
PA6 SPI1_MISO SPI1
PA7 SPI1_MOSI SPI1
 
SPIDEV  adxl355     SPI1 DEVID1 ADXL_CS     MODE0   1*MHZ   4*MHZ
SPIDEV  adxrs290a   SPI1 DEVID2 ADXRSa_CS   MODE3   1*MHZ   4*MHZ
SPIDEV  adxrs290b   SPI1 DEVID3 ADXRSb_CS   MODE3   1*MHZ   4*MHZ

# one IMU
IMU ADXL355 SPI:adxl355 ROTATION_NONE
IMU ADXRS290 SPI:adxrs290a SPI:adxrs290b ROTATION_NONE ROTATION_NONE 

# define HAL_DEFAULT_INS_FAST_SAMPLE 2
# DMA_NOSHARE SPI1* 


define HAL_OS_FATFS_IO 1
define HAL_BOARD_LOG_DIRECTORY "/APM/LOGS"
define HAL_BOARD_TERRAIN_DIRECTORY "/APM/TERRAIN"


